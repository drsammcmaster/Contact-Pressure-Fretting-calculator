import math
import tkinter as tk
from tkinter import filedialog, simpledialog, messagebox

# Function to calculate the coefficient of friction
# This function takes the friction force and normal force as inputs

#Friction force is in mN 
# Normal force is in mN 

def coefficient_of_friction(friction_force, normal_force):
    if normal_force == 0:
        raise ValueError("Normal force cannot be zero.")
    return friction_force / normal_force

# Function to read time and friction data from a file
# Each line in the file should contain time and friction force separated by whitespace

def read_time_and_friction_from_file(filename):
    times = []
    frictions = []
    with open(filename, 'r') as file:
        for line in file:
            if line.strip():
                parts = line.strip().split()
                if len(parts) < 2:
                    raise ValueError("Each line must have at least two columns: time and friction.")
                time = float(parts[0])
                friction = float(parts[1])
                times.append(time)
                frictions.append(friction)
    return times, frictions

# Average the values over a specified number of cycles (groups).
# This function takes a list of values and a cycle size, and returns the average for each group.

def average_over_cycles(values, cycle_size):
    """Average the values over a specified number of cycles (groups)."""
    if cycle_size < 1 or cycle_size > len(values):
        raise ValueError("Cycle size must be between 1 and the length of the values list.")
    averaged = []
    for i in range(0, len(values), cycle_size):
        group = values[i:i+cycle_size]
        avg = sum(group) / len(group)
        averaged.append(avg)
    return averaged

if __name__ == "__main__":
    root = tk.Tk()
    root.withdraw()  # Hide the main window

    # File open dialog
    filename = filedialog.askopenfilename(
        title="Select friction force data file",
        filetypes=[("Text Files", "*.txt"), ("All Files", "*.*")]
    )
    if not filename:
        messagebox.showerror("Error", "No file selected.")
        exit()

    # Normal force input dialog
    try:
        normal_force = float(simpledialog.askstring("Normal Force", "Enter the normal force (mN):"))
    except (TypeError, ValueError):
        messagebox.showerror("Error", "Invalid normal force entered.")
        exit()

    # Read time and friction data from the file and calculate the maximum friction force per cycle and the coefficient of friction for each cycle.

    try:
        times, frictions = read_time_and_friction_from_file(filename)
        total_points = len(frictions)
        # Ask user for number of cycles
        num_cycles = simpledialog.askinteger("Number of Cycles", "Enter the number of friction cycles:", initialvalue=50, minvalue=1, maxvalue=total_points)
        if not num_cycles or num_cycles < 1:
            messagebox.showerror("Error", "Invalid number of cycles entered.")
            exit()
        points_per_cycle = total_points // num_cycles
        remainder = total_points % num_cycles

        # Split frictions into num_cycles groups, distributing remainder points to the first groups
        result_lines = [
            "Cycle\tMax friction (mN)\tMin friction (mN)\tCoefficient of Friction",
        ]
        start = 0
        for i in range(num_cycles):
            group_size = points_per_cycle + (1 if i < remainder else 0)
            group = frictions[start:start+group_size]
            if group:
                max_f = max(group)
                min_f = min(group)
                # Correct calculation: (max friction - min friction) / 2
                calc_friction = (max_f - min_f) / 2
                mu = coefficient_of_friction(calc_friction, normal_force)
            else:
                max_f = min_f = calc_friction = mu = 0
            result_lines.append(f"{i+1}\t{max_f:.6f}\t{min_f:.6f}\t{mu:.6f}")
            start += group_size

        messagebox.showinfo("Result", "Max, min, and coefficient of friction per cycle.")
    except Exception as e:
        messagebox.showerror("Error", str(e))
        exit()

    # File save dialog
    export_filename = filedialog.asksaveasfilename(
        title="Export averaged coefficient of friction per cycle",
        defaultextension=".txt",
        filetypes=[("Text Files", "*.txt"), ("All Files", "*.*")]
    )
    if export_filename:
        with open(export_filename, 'w') as f:
            f.write('\n'.join(result_lines))
        messagebox.showinfo("Exported", f"Result exported to {export_filename}")
